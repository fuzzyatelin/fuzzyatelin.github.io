---
title: "Lab 5 - Neutrality Statistics and Selection"
author: "Becca DeCamp & Christopher Schmitt"
date: "10/26/2018"
output: html_document
---

## Introduction to Neutrality Statistics and Signs of Selection

***

###[Homework for Lab 5: DUE Friday, November 9th](https://fuzzyatelin.github.io/AN333_Fall18/Lab5_Homework.html)

***

**Readings**:<ul> 
<li>[Garrigan DR, Lewontin R, Wakeley J. 2010. Measuring the sensitivity of single-locus “neutrality tests” using a direct perturbation approach. *Mol Biol Evol* 27(1): 73-89.](https://academic.oup.com/mbe/article/27/1/73/1125718)</li><br>
<li>[Southam L, Soranzo N, Montgomery SB, Frayling TM, McCarthy MI, Barroso I, Zeggini E. 2009. Is the thrifty genotype hypothesis supported by evidence based on confirmed type 2 diabetes- and obesity-susceptibility variants? *Diabetologia* 52: 1846-1851.](https://link.springer.com/article/10.1007%2Fs00125-009-1419-3)</li><br>
<li>[Tajima F. 1989. Statistical method for testing the neutral mutation hypothesis by DNA polymorphism. *Genetics* 123(3): 585–595.](http://www.genetics.org/content/123/3/585)</li></ul>

***

In this lab, we we'll take our first look at *neutrality statistics*, which are statistical tests designed to measure if whether SNPs appear to be undergoing selection within a population. We'll go over what each of the statistics are, what they mean, and how to interpret them, and then we'll use them on our own data (with the exception of our final statistic, *iHS*, which is for whole sequence data, not variant calls).
<br>
<br>
First, let's get an understanding of what each of these statistics might mean when calculated for our populations...

### Tajima's D
This is a fairly common neutrality statistic. For this lab, we've read the [original paper by Tajima](), which details the development of his D statistic as a way of testing for the *neutral mutation hypothesis* (or Kimura's theory of neutral mutation, as we've discussed it in class). Tajima's D tests whether the pattern of mutations found in a particular region of the genome in a population is following the assumptions of neutrality models; in other words, if there has been selection for or against a particular allele in the population, the pattern seen will *violate* the assumptions of the neutral model.
<br>
<br>
With Tajima's D, the closer to 0 the D statistic is, the closer the locus being tested is to meeting the assumptions of neutrality. In other words, when D is close to 0 there are no alleles over- or under-represented at that locus across the population, suggesting that selection is *not* acting on that locus in the population. If the D statistic is a negative number, this means the population is experiencing *purifying* or *negative* selection against an allele at that locus. Conversely, if the D statistic is positive, this means that the population is experiencing *positive* selection at the locus.<br><br> Today, we'll calculate Tajima's D values for *our* populations in order to determine if any directional selection is happening at the *UCP1* locus. 
<br>

### Fu and Li's D and F

Fu and Li's D and F are also fairly straightforward tests derived from the same $\Theta$ statistics as Tajima's D. Like Tajima's D, these statistics are also based upon Kimura's neutrality statistic, again meaning that anything deviating from 0 is a violation of neutrality. What these statistics do, specifically, is measure the number of *singleton* or *private* mutations (i.e., the number of people within a sample that have a novel mutation specific to themselves). While the *D statistic* is based on the difference between the number of singletons in the population and the *total number of mutations in population*, the *F statistic* is based on the difference between the number of singletons and the *average number of nucleotide differences between pairs of sequences*. This difference in how they're derived makes it possible for one statistic to be positive while the other is negative in the same population.<br><br>
We can interpret these statistics like so:

* If the statistics are strongly negative, this shows an *excess of singletons* in the population. This means there are quite a few people whose genomic variants don't match each other. Such a situation could be from rapid population growth (meaning everyone is closely related and so there's been no time for mutation to catch up to the increased numbers) or a *selective sweep* (see below for a formal definition) further back in the population's history, meaning that strong directional selection for a certain mutation led to an overrepresentation of that mutation (at the expense of other variants at that SNP).

* If the statistics are positive, this indicates an *excess of old/ancestral variants*, that have been selected for in the past. In other words, there are very few unique variants, and the variants that are present are carried by a lot of individuals.
<br><br>

We will calculate Fu and Li's D and F statistics for our data today. 

### Integrated Haplotype Score (iHS)

Recent positive selection usually happens by *selective sweeps* (i.e. the rapid spread of a particular haplotype, driven by selection for particular alleles within that haplotype), which not only act upon the SNP that corresponds to the phenotype under selection, but the *entire haplotype* or *linkage region* in which that SNP is found. When this happens, the alleles in these selected haplotypes become almost entirely homozygous, because selection on this region of the genome is so strong. An *iHS score*, or an *Integrated Haplotype Score*, is a test that can be used to measure the amount of recent positive selection experienced by an allele indirectly by looking for evidence of selective sweeps. This test identifies *extended haplotypes* (large sets of SNPs on a single region of the chromosome) and looking at how many of the SNPs are homozygous in each haplotype. Mass homozygosity in a particular haplotype is recorded as a *high* iHS score, while low levels of homozygosity is recorded as a *low* iHS score.<br> 

## Learning Outcomes

* Learn what Fu and Li's D and F, Tajima's D, and iHS scores mean, and how to interpret them. 

* Learn to use the *PopGenome* package to calculate neutrality statistics such as Fu and Li's D and F, and Tajima's D.

* Learn to use the *pegas* package to explore our Tajima's D statistic further.

* Learn about iHS by working through an example of how to calculate iHS in *R*, and reflect on what the iHS score for our population's *UCP1* haplotype might look like. 

* Learn about whether or not selection is happening in our populations based on these statistics, and relate it to environments that may cause these alleles in *UCP1* to be selected for or against.

## Part 1: Getting Started

Log in to the *SCC* and bring up the *R Studio* window [as usual](https://fuzzyatelin.github.io/AN333_Fall18/Lab_2_-_HWE.html): 
```{bash, eval = F, echo = T}
module load gcc
module load R
rstudio &
```

Next, we need to install the package *PopGenome* in our *R Studio* space, because the SCC doesn't have it pre-installed.
```{r, eval=F, echo=T}
#We need to install this package
install.packages("PopGenome")
```

Next, load in the packages we need to use:
```{r, results='hide', message=F, warning=F}
library(vcfR)
library(PopGenome)
library(pegas)
```

Finally, we need to format our data for analysis. *PopGenome* is a bit funky about how they look for the files in your directory, so we need to move some files around in our folders to make the *GENOME* object that the *PopGenome* package will work with. Specifically, if you haven't already done so, we need to make a new directory within our working directory, and put a copy of our data into that folder. Do this in your *SCC* space using the *mkdir* and *cp* commands (remember to use *your* population name rather than YRI!):
```{bash, eval = F, echo = T}
mkdir YRI
cp YRI.vcf YRI/YRI.vcf
```

Now, we can make our *GENOME* object by directing the function to the folder we just created. Additionally, we'll make a *DNAbin* object ([as we have done before](https://fuzzyatelin.github.io/AN333_Fall18/Lab4-Phylogeny.html)) to save for later... 
<br>
Here we'll make our *GENOME* object:
```{r}
YRIgenome <- readData("YRI", format = "VCF")
YRIgenome
```

And here we'll make our *DNAbin* object:
```{r}
YRI <- read.vcfR("YRI/YRI.vcf")
YRIdna <- vcfR2DNAbin(YRI)
YRIdna
```

## Part 2: Fu and Li's D and F

The function `neutrality.stats` from *PopGenome* conveniently calculates several different neutrality statistics for a given population. We'll use it now to calculate Fu and Li's D and F: 

```{r}
#Remember to replace the varible name with your own GENOME object!
neut <- neutrality.stats(YRIgenome)
get.neutrality(neut)

#To see results: 

neut@Fu.Li.F
neut@Fu.Li.D
```

As we can see here, the YRI population has D and F statistics that are pretty close to 0. This suggests neither an excess of singleton mutations in this population, nor an excess of ancestral mutations. Put simply, the *UCP1* region in the Yoruban population from Ibadan hasn't evolved much in recent history, which we might expect from an African population with little experience with extreme cold temperatures. 
<br>
<br>
Before we move on, think about what the results for *your* population means, based on how we interpret Fu and Li's D. Is there an excess of singletons? Is there an excess of old/ancestral mutations? What does that tell you about *your* population's history? We will come back to this at the end of class. 
<br>

## Part 3: Tajima's D

Now we'll look at Tajima's D! When we ran the `neutrality.stats` function in *PopGenome*, it also calcuated our Tajima's D statistic. We can *preview* our Tajima's D results from the *PopGenome* output... 
```{r}
neut@Tajima.D
```

But, we can get more useful information by using the `tajima.test` function in the *pegas* package. This function will use the *DNAbin* object that we created earlier as an input. It will not only give us the same D statistic as was calculated by the `neutrality.stats` function, which is all well and good, but will also give us a *P-value* associated with our test. This is important, because it will give us a sense of how significant the results are of our neutrality test. 
<br>
```{r}
tajima <- tajima.test(YRIdna)
tajima
```

What we see from YRI is, again, what we might expect from a population that has been living in a warm climate for many generations: the *UCP1* locus in this population does not appear to be subject to selection. This suggests that the only *evolution* (remember, that's a change in allele frequencies over generations, and does *not* have to be due to selection) happening in the population is selectively neutral. 
<br>
<br>
Interpret your own population's Tajima's D value. First, compare the D value given by this function and the one given by the `neutrality.stats` function. Are they the same? What is the D statistic for your population, and what does it mean in terms of whether and what kind of selection might be occuring on your population? We will revisit this question at the end of the lab.

## Part 4: An Example of iHS... with Cows
<br><center>
![](cow.gif)
</center><br>

Now, we will run our example of *iHS*. To run this example, I'm using the *rehh* package, which is specifically designed to look for *Extended Haplotype Homozygosity*, or evidence of selective sweeps. We can use this package to look at an example of calculating an iHS score. For a fun digression from human data, the genomic dataset included in the *rehh* package is from cows! You *can* use 1000 Genomes Project data with this package, but that requires you to map and *phase* the data with other genomic analysis-specific programs such as *SHAPEIT* and *Beagle*... that's a bit more than we're ready to do. Sooo... we'll just use the cows. If you'd like to learn more about the cow genome, [you can read about (and query) the cow genome here](bovinegenome.org/). You can also find the cow genome on *Ensembl*, but it's unfortunately not yet annotated there (meaning we cannot yet *easily* make the connection between a chromosomal location and the genes it contains that are similar to those of humans). Even though our example population is a bit more bovine than usual, as we walk through this example, make some predictions about what an iHS score in *your* population might look like. 
<br>
<br>
The first thing we'll do is pull the example files from the package and create a *haplohh* object, which is what the *rehh* package reads for analyses: 

```{r,message=F}
library(rehh)
```
```{r,eval = F, echo = T}
#puts example files in our working directory
make.example.files()
```
```{r}
#read in files as a haplohh object
hap <- data2haplohh(hap_file="bta12_cgu.hap",map_file="map.inp", recode.allele = TRUE, chr.name = 12)
```

Once this is done, we can run the iHS function. The first line of code looks for the haplotypes within the data, and the second calculates the iHS score for every allele:

```{r, warning=FALSE, error=FALSE}
ehh <- scan_hh(hap,limhaplo=2,limehh=0.05,limehhs=0.05,maxgap=NA,threads=1)
head(ehh)

#this will give us a long list of iHS scores... why read the list when we can just plot it?!
ihs <- ihh2ihs(ehh,freqbin=0.025,minmaf=0.05)
```

Finally, to take in the entirety of our iHS scores, we'll graph our results! The dotted line represents the *threshhold of significance* of each iHS score: 
```{r}
ihsplot(ihs, plot.pval=TRUE, ylim.scan=2, pch=16, main="iHS")
```
![](iHSplot.png)
![](iHSplot2.png)

What we're seeing here are two plots representing a map of cow chromosome 12 (which is homologous to human chromosome 13), demarcated on the x-axis by chromosomal positions of SNPs (the ticks on the x-axis are every 20 Mb, or mega-bases, or 20-million-base increments; cow chromosome 12 is a little over 91 Mb long). The y-axis of the first graph is, more or less, the absolute value of the calculated iHS scores; the second is the untransformed value of iHS across the chromosome. The format of these plots is called a *Manhattan plot*, because the peaks and valleys of the data as you scan across the chromosome look a bit like the skyline of Manhattan.
<br><br>
You can see that that there are several SNPs that are above/below the iHS score significance threshhold, particularly around 30 Mb along chromosome 12. This means that these SNPs exist in the population as part of massively homozygous blocks in this region of the cow genome, which means there was most likely a selective sweep that happened in this population on a phenotype coded by an allele (or multiple alleles) located in this block 30Mb along chromosome 12! Cows have, in the past, apparently adapted to *some* selective pressure that has acted to maintain homozygosity across the population in this region of their genome. To discover what it is, we'd have to see what genes are in this homozygous haplotype block, but without annotation it's a bit too difficult for us to manage in this course. If this were the human genome, we would simply go to *Ensembl* and query this position range and see what gene regions are contained therein. These genes would then be *candidate genes* for understanding what selective force has been acting on which phenotype.
<br>
<br>
Now think about what an iHS score might look like in your population. Based on what we've discovered today about inferring selection in our populations, do you think that a selective sweep may have happened in the *UCP1* region of *your* population? Is there anything that you know about the environment and your population's potential adaptations to that environment that you can use to aid in your analysis?

## Part 5: What Do Your Results Mean? Discuss with a partner from class:

As we wrap up this lab, think about the results you've generated. You have already been prompted to think about what your results might mean as we've gone along; now you have the opportunity to talk to a partner about what you think your results might mean.

* Think about what your results mean, based on how we interpret Fu and Li's D. Is there an excess of singletons in your population? Is there an excess of old/ancestral mutations? What might that tell you about your population's history? 

* What is the Tajima's D statistic and accompanying P-value for your population, and what does that mean regarding potential selection happening on your population?

* What do you think an iHS score might look like for your data, based on the other results you've generated? Based on what we've discovered today about selection happening in our populations, do you think that a selective sweep may have happened in the *UCP1* region for you population? Is there anything that you know about the environment and your population's adaptations to the environment that you can use to aid in your analysis?
<br>
<br>
<br>