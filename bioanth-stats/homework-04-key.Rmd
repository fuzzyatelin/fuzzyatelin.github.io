---
title: "Z.prop.test"
author: "Christopher A Schmitt"
date: "October 23, 2017"
output: html_document
---

```{r}
Z.prop.test<-function(p1,n1,p2=NULL,n2=NULL,p0,alternative="two.sided",conf.level=0.95)
{
  if(is.na(p1))
    stop("You must enter a value for 'p1'!")
  if(is.na(n1))
    stop("You must enter a value for 'n1'!")
  if(is.na(p0))
    stop("You must enter a value for 'p0'!")
  if(!missing(conf.level) &&
       (length(conf.level) != 1 || !is.finite(conf.level) ||
        conf.level < 0 || conf.level > 1))
    stop("'conf.level' must be a single number between 0 and 1")
  if(is.null(p2) || is.null(n2)) {
    phat<-p1
    pi<-p0
    n<-n1
    z<-(phat-pi)/sqrt(pi*((1-pi)/n1))
      names(z)<-"Z score"
  }
  else {
    phat1<-p1
    phat2<-p2
    pi<-p0
    n1<-n1
    n2<-n2
    z<-(phat2-phat1)/sqrt((p0*(1-p0))*(1/n1+1/n2))
        names(z)<-"Z score"
  }
  
if(alternative=="two.sided") {p<-1-pnorm(z,lower.tail=TRUE)+pnorm(z,lower.tail=FALSE)
                        names(p)<-"P-value"
                        lower<-sqrt(((phat1*(1-phat1))/n1)+((phat2*(1-phat2))/n2))
                        upper<-pi+qnorm(1-conf.level/2)*sqrt(pi*(1-pi)/n1)
                        ci<-c(lower,upper)
                        names(ci)<-"CI"
                        crit<-qnorm(conf.level/2)
                        test<-p<-crit || p>crit}
if(alternative=="lower") {p<-pnorm(z,lower.tail=TRUE)
                          names(p)<-"P-value"
                          lower<-phat-qnorm(1-conf.level/2)*sqrt(phat*(1-phat)/n1)
                          upper<-phat+qnorm(1-conf.level/2)*sqrt(phat*(1-phat)/n1)
                          ci<-c(lower,upper)
                          names(ci)<-"CI"
                          crit<-qnorm(conf.level/2)
                          test<-p<-crit || p>crit}
if(alternative=="upper") {p<-pnorm(z,lower.tail=FALSE)
                          names(p)<-"P-value"
                          lower<-phat-qnorm(1-conf.level/2)*sqrt(phat*(1-phat)/n1)
                          upper<-phat+qnorm(1-conf.level/2)*sqrt(phat*(1-phat)/n1)
                          ci<-c(lower,upper)
                          names(ci)<-"CI"
                          crit<-qnorm(conf.level/2)
                          test<-p<-crit || p>crit}
  
RVAL <- list(statistic = z, 
        p.value = as.numeric(p), 
        conf.int = ci, 
        alternative = alternative)
    class(RVAL) <- "htest"
    return(RVAL)
}

```